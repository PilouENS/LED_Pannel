// Code principale 

#include "LPC8xx.h"
#include "gpio_config.h"        // Extension maison
#include "swm.h"
#include "syscon.h"
#include "iocon.h"
#include "fro.h"
#include "rom_api.h"
#include "chip_setup.h"
#include <stdint.h>


// Fonction pour initialiser les sortie vers le panneau led
void initGPIO(void) {
    // Activer l'horloge pour GPIO
    LPC_SYSCON->SYSAHBCLKCTRL0 |= (1 << 6); // GPIO activé

    // Libérer les affectations de la Switch Matrix
    LPC_SWM->PINASSIGN[0] = 0xFFFFFFFF;
    LPC_SWM->PINASSIGN[1] = 0xFFFFFFFF;
    LPC_SWM->PINASSIGN[2] = 0xFFFFFFFF;

    // Configurer toutes les broches nécessaires comme sorties
    LPC_GPIO_PORT->DIR0 |= (1 << RED1_PIN) | (1 << RED2_PIN) | (1 << RED3_PIN) | (1 << RED4_PIN) |
                           (1 << BLUE1_PIN) | (1 << BLUE2_PIN) | (1 << BLUE3_PIN) | (1 << BLUE4_PIN) |
                           (1 << GREEN1_PIN) | (1 << GREEN2_PIN) | (1 << GREEN3_PIN) | (1 << GREEN4_PIN) |
                           (1 << CLOCK_PIN) | (1 << OUTPUT_EN_PIN) | (1 << LE_PIN) |
                           (1 << SEQ1_PIN) | (1 << SEQ2_PIN);

    // Initialiser toutes les broches à 0
    LPC_GPIO_PORT->CLR0 = 0xFFFF;
}

// Fonction qui met à 1 la sortie pin
void setPinHigh(uint8_t pin) {
    LPC_GPIO_PORT->SET0 = (1 << pin);
}

// Fonction qui met à 0 la sortie pin
void setPinLow(uint8_t pin) {
    LPC_GPIO_PORT->CLR0 = (1 << pin);
}



// Fonction main
int main(void) {
    initGPIO(); // Initialisation des GPIO

    // Initialisation du TIMER0 a 1kHz
    LPC_SYSCON->SYSAHBCLKCTRL0 |= CTIMER0;
    LPC_CTIMER0->PR = 100;
    LPC_CTIMER0->TCR |= 1;

    int c = 0;
    int l = 0;

    // vecteur des pixel permettant d'afficher un coeur
    char data[768] = {0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0xff,0xfb,0x00,0xff,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,
    		0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0xfb,
			0x00,0x00,0xfb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfb,0x00,0x00,0xfb,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfb,
			0x00,0x00,0xfb,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

			0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,

			0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf9,0x00,0x00,0xf9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			};

    int intensite = 0;



	// Met output enable
    // Boucle principale
	while (1)
	{
		// On utilise le CTIMER0 pour avoir une horloge de fréquence donné
		if(LPC_CTIMER0->TC>=1)
		{
		// On met la clock a zero, on peut ensuite assigner chaque pin
		setPinLow(CLOCK_PIN);
		setPinLow(LE_PIN);


		// On gère la Pin 1 rouge
		if (intensite<data[3*(16*l+c)])	// Condition sur la colone pour allumer la led avec intensité
		{
			setPinHigh(RED1_PIN);
		}
		else
		{
			setPinLow(RED1_PIN);
		}


		// On gère la Pin 2 rouge
		if (intensite<data[3*(16*l+c)+192])	// Condition sur la colone pour allumer la led avec intensité
		{
			setPinHigh(RED2_PIN);
		}
		else
		{
			setPinLow(RED2_PIN);
		}

		// On gère la Pin 3 rouge
		if (intensite<data[3*(16*l+c)+384])	// Condition sur la colone pour allumer la led avec intensité
		{
			setPinHigh(BLUE4_PIN);
		}
		else
		{
			setPinLow(BLUE4_PIN);
		}

		// On gère la Pin 4 rouge
		if (intensite<data[3*(16*l+c)+576])	// Condition sur la colone pour allumer la led avec intensité
		{
			setPinHigh(BLUE1_PIN);
		}
		else
		{
			setPinLow(BLUE1_PIN);
		}


		// On envoie sur chaque ligne
		if (l==1)
		{
			setPinLow(SEQ1_PIN);
			setPinLow(SEQ2_PIN);
		}
		else if (l==3)
		{
			setPinHigh(SEQ1_PIN);
			setPinLow(SEQ2_PIN);
		}
		else if (l==2)
		{
			setPinLow(SEQ1_PIN);
			setPinHigh(SEQ2_PIN);
		}
		else if (l==0)
		{
			setPinHigh(SEQ1_PIN);
			setPinHigh(SEQ2_PIN);
		}


		intensite++;
		if (intensite>=255)
		{
			intensite=0;
		}
		c++;
		if (c>=16)
		{
			setPinHigh(LE_PIN);
			c=0;
			l++;
			if (l>=4)
			{
				l=0;
			}
		}



		setPinHigh(CLOCK_PIN);

		LPC_CTIMER0->TC = 0;
		}
	}

	return 0;
}




















// Extension .h pour assigner les sorties

#ifndef GPIO_CONFIG_H
#define GPIO_CONFIG_H



// Définitions pour simplifier l'accès aux GPIO
#define RED1_PIN  0  // PIO0_0
#define RED2_PIN  1  // PIO0_1
#define RED3_PIN  2  // PIO0_4
#define RED4_PIN  3  // PIO0_7

#define BLUE1_PIN 4  // PIO0_2
#define BLUE2_PIN 5  // PIO0_5
#define BLUE3_PIN 6  // PIO0_6
#define BLUE4_PIN 7  // PIO0_3

#define GREEN1_PIN 8   // PIO0_8
#define GREEN2_PIN 9   // PIO0_9
#define GREEN3_PIN 10  // PIO0_10
#define GREEN4_PIN 11  // PIO0_11

#define CLOCK_PIN      12 // PIO0_12
#define OUTPUT_EN_PIN  13 // PIO0_13
#define LE_PIN         14 // PIO0_14
#define SEQ1_PIN       15 // PIO0_15
#define SEQ2_PIN       16 // PIO0_16

// Prototypes des fonctions
void initGPIO(void);
void setPinHigh(uint8_t pin);
void setPinLow(uint8_t pin);

#endif // GPIO_CONFIG_H

